# **Задача лабы**

настроить nginx по тз:
- Должен работать по https c сертификатом
- Настроить принудительное перенаправление HTTP-запросов (порт 80) на HTTPS (порт 443) для обеспечения безопасного соединения.
- Использовать alias для создания псевдонимов путей к файлам или каталогам на сервере.
- Настроить виртуальные хосты для обслуживания нескольких доменных имен на одном сервере.


------------------------------------------------------------------------

# **Ход работы**

## **1. Сделаем себе аквариум (песочницу)**
Таки накатим на VirtualBox Ubuntu Server (последний LTS)
Сразу я уверен что будут проблемы, если делать через bridge (вайфай итмо не щадит), поэтому сеть делаем через NAT и пробрасываем порты 80->80 443->443

```
sudo apt update
sudo apt upgrade
sudo apt install openssl nginx
```
Аквариум готов к работе

------------------------------------------------------------------------

## **2. Да будет загрузка сайтов**
Сайтики у нас будут лежать в /var/www/site1 и /var/www/site2, создадим в обоих папках незамысловатые index.html
```
<h1>Site1/2</h1>
```

Нам нужны домены, даже 2, нужно готовим хостовую ОС, прописываем в hosts:
```
127.0.0.1 site1.local
127.0.0.1 site2.local
```

Дальше мы сделаем как умные мальчики, пойдем в /etc/nginx/sites-available, создадим тут 2 начальных конфига (они отличаются только циферкой, поэтому вставлю только один):

site1.conf
```
server {
    listen 80;
    server_name site1.local;

    root /var/www/site1;
    index index.html;
}
```

отлично, теперь создадим симлинк на эти файлы в /etc/nginx/sites-enabled
```
sudo ln -s /etc/nginx/sites-available/site1.conf /etc/nginx/sites-enabled/
sudo ln -s /etc/nginx/sites-available/site2.conf /etc/nginx/sites-enabled/
```

Почему мы сделали как умные? Потому что если бы мы копировали, нам нужно было менять конфиг в 2-х местах сразу. А симлинк позволяет нам менять только в одном месте, и очень удобно добавлять/удалять из включенных сайтов nginx-а

Проверим правильность конфига
```
sudo nginx -t
```
ого, ok????

И перезагружаем службу
```
sudo systemctl reload nginx
```

Заходим на сайты с хостовой ОС, победа, 2 домена на одном IP и порту

<img width="601" height="207" alt="image" src="https://github.com/user-attachments/assets/9118b53d-2d19-48da-8126-c0ae32637b51" />
<img width="933" height="180" alt="image" src="https://github.com/user-attachments/assets/34c4c09f-201b-459e-a25a-092426f16490" />

------------------------------------------------------------------------

## **3. Прикрутим алиасы**
Для начала создадим надуманную проблему: я хочу иметь папку /var/www/site1/static-images в которой лежат картинки, но достучаться до ней повеливаю только по ручке /images. А тут я вспомнил времена Apache, когда выгружался полный каталог при запросе. Сделаем и тут.

добавим в /var/www/site1/static-images фоточки 1.png и 2.png

а теперь конфиг

```
    ...
    location /images {
        alias /var/www/site1/static-images/;
        autoindex on;
    }
}
```

благодаря алиасу мы связали ручку с файлами папки с другим названием, а благодаря ```autoindex``` мы получили вот такой вывод

<img width="857" height="260" alt="image" src="https://github.com/user-attachments/assets/4b8b843f-cdaf-470f-831a-c59065c2d1c7" />

------------------------------------------------------------------------

## **4. SSL сертификат и редирект**
Создадим сертификаты для сайтов, будем подписывать сами, т.к. домены локальные

```
sudo openssl req -x509 -nodes -days 365 \
  -newkey rsa:2048 \
  -keyout /etc/ssl/private/site1.key \
  -out /etc/ssl/certs/site1.crt \
  -subj "/CN=site1.local"
```

Сразу сделаем и редирект, и подключим сертификаты

Ныряем в конфиг:

<img width="490" height="408" alt="image" src="https://github.com/user-attachments/assets/0e47ce5f-1ef5-4466-bd8b-9ee71685bacc" />

Если человек идет по 80 порту, то мы намекаем что это HTTP 301, перманентный редирект, и сохраняем его запрос.

Проверим, что есть редирект, сертификат, и сохраняется URI:

<img width="582" height="397" alt="image" src="https://github.com/user-attachments/assets/57b1caae-f7d3-427b-92c6-dc8a4bb4ada4" />
<img width="817" height="431" alt="image" src="https://github.com/user-attachments/assets/06bcc5c7-bf7e-456b-80ff-4f3b203acf07" />

Кажется, это победа


